<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CRUD Oficina</title>
    <link rel="stylesheet" href="/styles/mainStyle.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="main-container">
      <header>
        <div class="title-container">
          <h1 class="title">Oficina de Mecânica</h1>
        </div>
      </header>
      <main>
        <div class="page-container">
          <h2>Peças</h2>
          <nav class="table-nav">
            <div class="table-main-nav-container">
              <div class="table-nav-container">
                <div>
                  <input
                    class="form-control mr-sm-2"
                    id = "inputQuery"
                    type="search"
                    placeholder="pesquisar por..."
                    aria-label="Search",
                    onchange="handleInputEvent()"
                  />
                </div>
                <button type="button" class="btn btn-outline-dark">Id</button>
                <button type="button" class="btn btn-outline-dark">Nome</button>
                <button type="button" class="btn btn-outline-dark">Tipo</button>
              </div>
              <div class="table-right-nav-container">
                <button type="button" class="btn btn-outline-dark">
                  registrar
                </button>
                <button type="button" class="btn btn-outline-dark">
                  deletar tudo
                </button>
              </div>
            </div>
          </nav>
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th scope="col">id</th>
                  <th scope="col">nome</th>
                  <th scope="col">tipo</th>
                  <th scope="col">preço</th>
                </tr>
              </thead>
              <tbody>
                <script>
                  const handleInputEvent  = () =>{
                    const input = document.getElementById("inputQuery");
                    populateRows(input.value)
                    console.log(input.value)
                  }
                  const getData = async (search) => {
                    try {

                      if (!search) {
                        console.log("...")
                        const response = await fetch(
                          "http://localhost:3001/pecas",
                          {
                            method: "GET",
                            mode: "cors",
                            headers: {
                              "Content-Type": "application/json",
                            },
                          }
                        );
                        if (!response.ok) {
                          throw new Error("Não consegui pegar os dados");
                        }
                        const data = await response.json();

                        return data.peças;
                      
                      } else {
                        query = encodeURI(search);
                        console.log(query)
                        const response = await fetch(
                          `http://localhost:3001/pecas/search?nome=${query}`,
                          {
                            method: "GET",
                            mode: "cors",
                            headers: {
                              "Content-Type": "application/json",
                            },
                          }
                        );
                        if (!response.ok) {
                          throw new Error(
                            "Não consegui pegar os dados durante a pesquisa"
                          );
                        }
                        const data = await response.json();
                        //console.log(data.peça);
                        return data.peça;
                      }
                    } catch (error) {
                      console.error(error);
                    }
                  };

                  const populateRows = async (search) => {
                    const data = await getData(search);
                    const tableBody = document.querySelector("tbody");
                    tableBody.innerHTML = "";
                    console.log(data);
                    data.forEach((data) => {
                      const tr = document.createElement("tr");
                      tr.innerHTML = `
                      <td>${data.id}</td>
                      <td>${data.nome}</td>
                      <td>${data.tipo}</td>
                      <td>${data.preco}</td>
                      `;
                      tableBody.appendChild(tr);
                    });
                  };

                  window.onLoad = populateRows();
                </script>
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
  </body>
</html>
