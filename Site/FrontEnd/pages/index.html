<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CRUD Oficina</title>
    <link rel="stylesheet" href="/styles/mainStyle.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="main-container">
      <header>
        <div class="title-container">
          <h1 class="title">Oficina de Mecânica</h1>
        </div>
      </header>
      <main>
        <div class="page-container">
          <h2>Peças</h2>
          <nav class="table-nav">
            <div class="table-main-nav-container">
              <div class="table-nav-container">
                <div>
                  <input
                    class="form-control mr-sm-2"
                    id="inputQuery"
                    type="search"
                    placeholder="pesquisar por nome"
                    aria-label="Search"
                    ,
                    onchange="handleInputEvent()"
                  />
                </div>
                <!-- <button type="button" class="btn btn-outline-dark">Id</button>
                <button type="button" class="btn btn-outline-dark">Nome</button>
                <button type="button" class="btn btn-outline-dark">Tipo</button> -->
              </div>
              <div class="table-right-nav-container">
                <button
                  type="button"
                  class="btn btn-outline-dark"
                  onclick="toggleForm()"
                >
                  registrar
                </button>
                <button
                  type="button"
                  class="btn btn-outline-dark"
                  onclick="handleDeleteButtonEvent()"
                >
                  deletar tudo
                </button>
              </div>
            </div>
          </nav>
          <div class="main-form-container">
            <form class="form-container">
              <div class="register-form-container" id="register-form">
                <h1>Registrar Peça</h1>

                <div class="input-container">
                  <a> nome </a>
                  <input
                    id="nameInput"
                    type="name"
                    placeholder="digite o nome da peça"
                    aria-label="nome"
                  />
                </div>
                <div class="input-container">
                  <a> tipo </a>
                  <input
                    id="typeInput"
                    type="name"
                    placeholder="digite o tipo da peça"
                    aria-label="nome"
                  />
                </div>
                <div class="input-container">
                  <a> preço </a>
                  <input
                    id="priceInput"
                    type="text"
                    placeholder="digite o preço da peça"
                    aria-label="nome"
                  />
                </div>
                <button
                  type="button"
                  class="btn btn-outline-light"
                  onclick="handleRegisterButtonEvent()"
                >
                  cadastrar
                </button>
                <button
                  type="button"
                  class="btn btn-outline-light"
                  onclick="toggleForm()"
                >
                  cancelar
                </button>
              </div>
            </form>
          </div>
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th scope="col">id</th>
                  <th scope="col">nome</th>
                  <th scope="col">tipo</th>
                  <th scope="col">preço</th>
                </tr>
              </thead>
              <tbody>
                <script>
                  const deleteReq = async () => {
                    try {
                      const req = await fetch(
                        "http://localhost:3001/pecas/apocalipse",
                        {
                          method: "DELETE",
                          mode: "cors",
                          headers: {
                            "Content-Type": "application/json",
                          },
                        }
                      );
                      const response = await req.json();
                      console.log(response);
                      populateRows();
                    } catch (error) {
                      window.alert(error);
                      console.error(error);
                    }
                  };
                  const windowAuth = async () => {
                    window.alert("Insira os dados de adm a seguir");
                    const nome = window.prompt("nome de usuario");
                    const senha = window.prompt("senha");
                    const user = {
                      nome: nome,
                      senha: senha,
                    };
                    try {
                      const response = await fetch(
                        "http://localhost:3001/adm/auth",
                        {
                          method: "POST",
                          mode: "cors",
                          headers: {
                            "Content-Type": "application/json",
                          },
                          body: JSON.stringify(user),
                        }
                      );
                      await response.json();
                      if (response.ok) {
                        window.alert("autenticação concedida");
                        deleteReq();
                        return true;
                      }else{
                        window.alert("autenticação negada")
                        return false
                      }
                    } catch (error) {
                      window.alert(error);
                    }
                  };
                  const erasePlaceholders = () => {
                    const nameInput = document.getElementById("nameInput");
                    const typeInput = document.getElementById("typeInput");
                    const priceInput = document.getElementById("priceInput");

                    priceInput.value = "";
                    nameInput.value = "";
                    typeInput.value = "";
                  };
                  const handleDeleteButtonEvent = async () => {
                    if (
                      window.confirm(
                        "Deseja realmente deletar todas as tabelas?"
                      )
                    ) {
                      console.log(windowAuth());
                    }
                  };
                  const handleRegisterButtonEvent = async () => {
                    const nameInput = document.getElementById("nameInput");
                    const typeInput = document.getElementById("typeInput");
                    const priceInput = document.getElementById("priceInput");

                    const valueName = nameInput.value;
                    const valueType = typeInput.value;
                    const valuePrice = Number(priceInput.value);

                    console.log(nameInput.value);
                    console.log(typeInput.value);
                    console.log(typeInput.value);
                    try {
                      const req = {
                        nome: valueName,
                        tipo: valueType,
                        preco: valuePrice,
                      };
                      const response = await fetch(
                        "http://localhost:3001/pecas",
                        {
                          method: "POST",
                          mode: "cors",
                          headers: {
                            "Content-Type": "application/json",
                          },
                          body: JSON.stringify(req),
                        }
                      );
                      await response.json();
                      console.log(response);
                      if (response.ok) {
                        window.alert(
                          `Peça registrada com sucesso: \n
                          nome: ${valueName}\n
                          tipo: ${valueType}\n
                          preço: ${valuePrice.toLocaleString("pt-BR", {
                            style: "currency",
                            currency: "BRL",
                          })}`
                        );
                        toggleForm();
                      } else {
                        window.alert(response.statusText);
                      }

                      erasePlaceholders();
                      populateRows();
                    } catch (error) {
                      window.alert(error);
                      console.error(error);
                    }
                  };
                  const toggleForm = () => {
                    console.log("toggle");
                    const form = document.getElementById("register-form");
                    form.style.display == "none"
                      ? (form.style.display = "flex")
                      : (form.style.display = "none");
                  };
                  const handleInputEvent = () => {
                    const input = document.getElementById("inputQuery");
                    populateRows(input.value);
                    console.log(input.value);
                  };
                  const getData = async () => {
                    try {
                      console.log("...");
                      const response = await fetch(
                        "http://localhost:3001/pecas",
                        {
                          method: "GET",
                          mode: "cors",
                          headers: {
                            "Content-Type": "application/json",
                          },
                        }
                      );
                      if (!response.ok) {
                        throw new Error("Não consegui pegar os dados");
                      }
                      const data = await response.json();
                      console.log(data);
                      return data.peças;
                    } catch (error) {
                      console.error(error);
                    }
                  };
                  const getDataByName = async (search) => {
                    try {
                      search = encodeURI(search);
                      const response = await fetch(
                        `http://localhost:3001/pecas/search?nome=${search}`,
                        {
                          method: "GET",
                          mode: "cors",
                          headers: {
                            "Content-Type": "application/json",
                          },
                        }
                      );
                      if (!response.ok) {
                        throw new Error(
                          "Não consegui pegar os dados durante a pesquisa"
                        );
                      }
                      const data = await response.json();
                      return data.peça;
                    } catch (error) {
                      console.error(error);
                    }
                  };
                  const populateRows = async (search) => {
                    console.log(search);
                    const data =
                      typeof search == "undefined" || search == ""
                        ? await getData()
                        : await getDataByName(search);
                    const tableBody = document.querySelector("tbody");
                    tableBody.innerHTML = "";
                    console.log(data);
                    if(data){
                      data.forEach((data) => {
                      const tr = document.createElement("tr");
                      tr.innerHTML = `
                                       <td>${data.id}</td>
                                       <td>${data.nome}</td>
                                       <td>${data.tipo}</td>
                                       <td>${data.preco}</td>
                                       `;
                      tableBody.appendChild(tr);
                    });
                    }
                   
                  };
                  (window.onLoad = populateRows()), toggleForm();
                </script>
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
  </body>
</html>
